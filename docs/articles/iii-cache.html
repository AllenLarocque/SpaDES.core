<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>03 Using `Cache` with `SpaDES` • SpaDES.core</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="03 Using `Cache` with `SpaDES`">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-58633549-6"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58633549-6');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpaDES.core</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/i-introduction.html">01 Introduction to `SpaDES`</a>
    </li>
    <li>
      <a href="../articles/ii-modules.html">02 Building modules in `SpaDES`</a>
    </li>
    <li>
      <a href="../articles/iii-cache.html">03 Using `Cache` with `SpaDES`</a>
    </li>
    <li>
      <a href="../articles/iv-advanced.html">04 Advanced `SpaDES` use -- in progress</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/PredictiveEcology/SpaDES.core">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>03 Using <code>Cache</code> with <code>SpaDES</code>
</h1>
                        <h4 class="author">Eliot J. B. McIntire</h4>
            
            <h4 class="date">November 19 2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/PredictiveEcology/SpaDES.core/blob/master/vignettes/iii-cache.Rmd"><code>vignettes/iii-cache.Rmd</code></a></small>
      <div class="hidden name"><code>iii-cache.Rmd</code></div>

    </div>

    
    
<p>As part of a reproducible work flow, caching of various function calls are a critical component. Down the road, it is likely that an entire work flow from raw data to publication, decision support, report writing, presentation building etc., could be built and be reproducible anywhere, on demand. The <code><a href="http://reproducible.predictiveecology.org/reference/cache.html">reproducible::Cache</a></code> function is built to work with any R function. However, it becomes very powerful in a <code>SpaDES</code> context because we can build large, powerful applications that are transparent and tied to the raw data that may be <em>many</em> conceptual steps upstream in the workflow. To do this, we have built several customizations within the <code>SpaDES</code> package. Important to this is dealing correctly with the <code>simList</code>, which is an object that has slot that is an environment. But more important are the various tools that can be used at higher levels, <em>i.e.</em>, not just for “standard” functions.</p>
<div id="caching-as-part-of-spades" class="section level1">
<h1 class="hasAnchor">
<a href="#caching-as-part-of-spades" class="anchor"></a>Caching as part of <code>SpaDES</code>
</h1>
<p>Some of the details of the <code>simList</code>-specific features of this <code>Cache</code> function include:</p>
<ul>
<li><p>The function converts all elements that have an environment as part of their attributes into a format that has no unique environment attribute, using <code>format</code> if a function, and <code>as.list</code> in the case of the <code>simList</code> environment.</p></li>
<li><p>When used within <code>SpaDES</code> modules, <code>Cache</code> (capital C) does not require that the argument <code>cacheRepo</code> be specified. If called from inside a SpaDES module, <code>Cache</code> will use the <code>cacheRepo</code> argument from a call to <code><a href="../reference/simList-accessors-paths.html">cachePath(sim)</a></code>, taking the <code>sim</code> from the call stack. Similarly, if no <code>cacheRepo</code> argument is specified, then it will use <code><a href="https://rdrr.io/r/base/options.html">getOption("spades.cachePath")</a></code>, which will, by default, be a temporary location with no persistence between R sessions! To persist between sessions, use <code>SpaDES::setPaths()</code> every session.</p></li>
</ul>
<p>In a <code>SpaDES</code> context, there are several levels of caching that can be used as part of a reproducible workflow. Each level can be used to a modeler’s advantage; and, all can be – and are often – used concurrently.</p>
<div id="at-the-spades-level" class="section level2">
<h2 class="hasAnchor">
<a href="#at-the-spades-level" class="anchor"></a>At the <code>spades</code> level</h2>
<p>And entire call to <code>spades</code> can be cached. This will have the effect of eliminating any stochasticity in the model as the output will simply be the cached version of the <code>simList</code>. This is likely most useful in situations where reproducibility is more important than “new” stochasticity (<em>e.g.</em>, building decision support systems, apps, final version of a manuscript).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(raster)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(reproducible)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(SpaDES.core)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">opts &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="st">"spades.moduleCodeChecks"</span> =<span class="st"> </span><span class="ot">FALSE</span>) <span class="co"># turns off syntactic checking of modules</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">mySim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simInit.html">simInit</a></span>(</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="dt">times =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">start =</span> <span class="fl">0.0</span>, <span class="dt">end =</span> <span class="fl">5.0</span>),</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  <span class="dt">params =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="dt">.globals =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">stackName =</span> <span class="st">"landscape"</span>, <span class="dt">burnStats =</span> <span class="st">"testStats"</span>),</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    <span class="dt">randomLandscapes =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">.plotInitialTime =</span> <span class="ot">NA</span>),</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="dt">fireSpread =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">.plotInitialTime =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">  ),</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">  <span class="dt">modules =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"randomLandscapes"</span>, <span class="st">"fireSpread"</span>),</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">  <span class="dt">paths =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">modulePath =</span> <span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"sampleModules"</span>, <span class="dt">package =</span> <span class="st">"SpaDES.core"</span>)))</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw"><a href="https://rdrr.io/r/base/options.html">options</a></span>(opts)</a></code></pre></div>
<p>This functionality can be achieved within a <code>spades</code> call.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># compare caching ... run once to create cache</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  outSim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spades.html">spades</a></span>(<span class="kw"><a href="http://reproducible.predictiveecology.org/reference/Copy.html">Copy</a></span>(mySim), <span class="dt">cache =</span> <span class="ot">TRUE</span>, <span class="dt">notOlderThan =</span> <span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>())</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">})</a></code></pre></div>
<pre><code>## [1] "2019-11-19 11:02:56 | total elpsd: 0.0031 secs | 0 checkpoint init 0"
## [1] "2019-11-19 11:02:56 | total elpsd: 0.0059 secs | 0 save init 0"
## [1] "2019-11-19 11:02:56 | total elpsd: 0.0077 secs | 0 progress init 0"
## [1] "2019-11-19 11:02:56 | total elpsd: 0.0094 secs | 0 load init 0"
## [1] "2019-11-19 11:02:56 | total elpsd: 0.011 secs | 0 randomLandscapes init 1"</code></pre>
<pre><code>## Loading required namespace: RandomFields</code></pre>
<pre><code>## [1] "2019-11-19 11:02:58 | total elpsd: 1.5 secs | 0 fireSpread init 1"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.5 secs | 1 fireSpread burn 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 1 fireSpread stats 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 2 fireSpread burn 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 2 fireSpread stats 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 3 fireSpread burn 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 3 fireSpread stats 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 4 fireSpread burn 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 4 fireSpread stats 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.6 secs | 5 fireSpread burn 5"
## [1] "2019-11-19 11:02:58 | total elpsd: 1.7 secs | 5 fireSpread stats 5"</code></pre>
<pre><code>## simList saved in
##  SpaDES.core:::.pkgEnv$.sim 
## It will be deleted at next spades() call.</code></pre>
<pre><code>##    user  system elapsed 
##   2.032   0.406   2.451</code></pre>
<p>Note that if there were any visualizations (here we turned them off with <code>.plotInitialTime = NA</code> above) they will happen the first time through, but not the cached times.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># vastly faster 2nd time</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  outSimCached &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spades.html">spades</a></span>(<span class="kw"><a href="http://reproducible.predictiveecology.org/reference/Copy.html">Copy</a></span>(mySim), <span class="dt">cache =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">})</a></code></pre></div>
<pre><code>##   loading cached result from previous spades call, adding to memoised copy</code></pre>
<pre><code>##    user  system elapsed 
##   0.061   0.001   0.062</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(outSim, outSimCached) </a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="module-level-caching" class="section level2">
<h2 class="hasAnchor">
<a href="#module-level-caching" class="anchor"></a>Module-level caching</h2>
<p>If the parameter <code>.useCache</code> in the module’s metadata is set to <code>TRUE</code>, then <em>every</em> event in the module will be cached. That means that every time that module is called from within a spades call, <code>Cache</code> will be called. Only the objects inside the <code>simList</code> that correspond to the <code>inputObjects</code> or the <code>outputObjects</code> from the module metadata will be assessed for caching. For general use, module-level caching would be mostly useful for modules that have no stochasticity, such as data-preparation modules, GIS modules etc.</p>
<p>In this example, we will use the cache on the <code>randomLandscapes</code> module. This means that each subsequent call to spades will result in identical outputs from the <code>randomLandscapes</code> module (only!). This would be useful when only one random landscape is needed simply for trying something out, or putting into production code (<em>e.g.</em>, publication, decision support, etc.).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># Module-level</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="../reference/params.html">params</a></span>(mySim)<span class="op">$</span>randomLandscapes<span class="op">$</span>.useCache &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  randomSim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spades.html">spades</a></span>(<span class="kw"><a href="http://reproducible.predictiveecology.org/reference/Copy.html">Copy</a></span>(mySim), <span class="dt">.plotInitialTime =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">                      <span class="dt">notOlderThan =</span> <span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>(), <span class="dt">debug =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">})</a></code></pre></div>
<pre><code>## This is the current event, printed as it is happening:
## eventTime moduleName eventType eventPriority
## 0         checkpoint init      0            
## 0         save       init      0            
## 0         progress   init      0            
## 0         load       init      0            
## 0         randomLandscapes init      1            
## 0         fireSpread       init      1            
## 1         fireSpread       burn      5            
## 1         fireSpread       stats     5            
## 2         fireSpread       burn      5            
## 2         fireSpread       stats     5            
## 3         fireSpread       burn      5            
## 3         fireSpread       stats     5            
## 4         fireSpread       burn      5            
## 4         fireSpread       stats     5            
## 5         fireSpread       burn      5            
## 5         fireSpread       stats     5</code></pre>
<pre><code>## simList saved in
##  SpaDES.core:::.pkgEnv$.sim 
## It will be deleted at next spades() call.</code></pre>
<pre><code>##    user  system elapsed 
##   1.189   0.111   1.274</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># vastly faster the second time</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  randomSimCached &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spades.html">spades</a></span>(<span class="kw"><a href="http://reproducible.predictiveecology.org/reference/Copy.html">Copy</a></span>(mySim), <span class="dt">.plotInitialTime =</span> <span class="ot">NA</span>, <span class="dt">debug =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">})</a></code></pre></div>
<pre><code>## This is the current event, printed as it is happening:
## eventTime moduleName eventType eventPriority
## 0         checkpoint init      0            
## 0         save       init      0            
## 0         progress   init      0            
## 0         load       init      0            
## 0         randomLandscapes init      1            
##   Using cached copy of randomLandscapes module
##  adding to memoised copy
## 0         fireSpread       init      1            
## 1         fireSpread       burn      5            
## 1         fireSpread       stats     5            
## 2         fireSpread       burn      5            
## 2         fireSpread       stats     5            
## 3         fireSpread       burn      5            
## 3         fireSpread       stats     5            
## 4         fireSpread       burn      5            
## 4         fireSpread       stats     5            
## 5         fireSpread       burn      5            
## 5         fireSpread       stats     5</code></pre>
<pre><code>## simList saved in
##  SpaDES.core:::.pkgEnv$.sim 
## It will be deleted at next spades() call.</code></pre>
<pre><code>##    user  system elapsed 
##   0.197   0.023   0.216</code></pre>
<p>Test that only layers produced in <code>randomLandscapes</code> are identical, not <code>fireSpread</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">layers &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"DEM"</span>, <span class="st">"forestAge"</span>, <span class="st">"habitatQuality"</span>, <span class="st">"percentPine"</span>, <span class="st">"Fires"</span>)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">same &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(layers, <span class="cf">function</span>(l)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">  <span class="kw"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(randomSim<span class="op">$</span>landscape[[l]], randomSimCached<span class="op">$</span>landscape[[l]]))</a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(same) &lt;-<span class="st"> </span>layers</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(same) <span class="co"># Fires is not same because all non-init events in fireSpread are not cached</span></a></code></pre></div>
<pre><code>## $DEM
## [1] TRUE
## 
## $forestAge
## [1] TRUE
## 
## $habitatQuality
## [1] TRUE
## 
## $percentPine
## [1] TRUE
## 
## $Fires
## [1] FALSE</code></pre>
</div>
<div id="event-level-caching" class="section level2">
<h2 class="hasAnchor">
<a href="#event-level-caching" class="anchor"></a>Event-level caching</h2>
<p>If the parameter <code>.useCache</code> in the module’s metadata is set to a <em>character or character vector</em>, then that or those event(s), identified by their name, will be cached. That means that every time the event is called from within a <code>spades</code> call, <code>Cache</code> will be called. Only the objects inside the <code>simList</code> that correspond to the <code>inputObjects</code> or the <code>outputObjects</code> as defined in the module metadata will be assessed for caching inputs or outputs, respectively. The fact that all and only the named <code>inputObjects</code> and <code>outputObjects</code> are cached and returned may be inefficient (<em>i.e.</em>, it may cache more objects than are necessary) for individual events.</p>
<p>Similar to module-level caching, event-level caching would be mostly useful for events that have no stochasticity, such as data-preparation events, GIS events etc. Here, we don’t change the module-level caching for <code>randomLandscapes</code>, but we add to it a cache for only the “init” event for <code>fireSpread</code>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="../reference/params.html">params</a></span>(mySim)<span class="op">$</span>fireSpread<span class="op">$</span>.useCache &lt;-<span class="st"> "init"</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">  randomSim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spades.html">spades</a></span>(<span class="kw"><a href="http://reproducible.predictiveecology.org/reference/Copy.html">Copy</a></span>(mySim), <span class="dt">.plotInitialTime =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">                      <span class="dt">notOlderThan =</span> <span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>(), <span class="dt">debug =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">})</a></code></pre></div>
<pre><code>## This is the current event, printed as it is happening:
## eventTime moduleName eventType eventPriority
## 0         checkpoint init      0            
## 0         save       init      0            
## 0         progress   init      0            
## 0         load       init      0            
## 0         randomLandscapes init      1            
## 0         fireSpread       init      1            
## 1         fireSpread       burn      5            
## 1         fireSpread       stats     5            
## 2         fireSpread       burn      5            
## 2         fireSpread       stats     5            
## 3         fireSpread       burn      5            
## 3         fireSpread       stats     5            
## 4         fireSpread       burn      5            
## 4         fireSpread       stats     5            
## 5         fireSpread       burn      5            
## 5         fireSpread       stats     5</code></pre>
<pre><code>## simList saved in
##  SpaDES.core:::.pkgEnv$.sim 
## It will be deleted at next spades() call.</code></pre>
<pre><code>##    user  system elapsed 
##   1.550   0.175   1.422</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="co"># vastly faster the second time</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">  randomSimCached &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spades.html">spades</a></span>(<span class="kw"><a href="http://reproducible.predictiveecology.org/reference/Copy.html">Copy</a></span>(mySim), <span class="dt">.plotInitialTime =</span> <span class="ot">NA</span>, <span class="dt">debug =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">})</a></code></pre></div>
<pre><code>## This is the current event, printed as it is happening:
## eventTime moduleName eventType eventPriority
## 0         checkpoint init      0            
## 0         save       init      0            
## 0         progress   init      0            
## 0         load       init      0            
## 0         randomLandscapes init      1            
##   Using cached copy of randomLandscapes module
##  adding to memoised copy
## 0         fireSpread       init      1            
##   Using cached copy of init event in fireSpread module.   
## 1         fireSpread       burn      5            
## 1         fireSpread       stats     5            
## 2         fireSpread       burn      5            
## 2         fireSpread       stats     5            
## 3         fireSpread       burn      5            
## 3         fireSpread       stats     5            
## 4         fireSpread       burn      5            
## 4         fireSpread       stats     5            
## 5         fireSpread       burn      5            
## 5         fireSpread       stats     5</code></pre>
<pre><code>## simList saved in
##  SpaDES.core:::.pkgEnv$.sim 
## It will be deleted at next spades() call.</code></pre>
<pre><code>##    user  system elapsed 
##   0.209   0.028   0.232</code></pre>
</div>
<div id="function-level-caching" class="section level2">
<h2 class="hasAnchor">
<a href="#function-level-caching" class="anchor"></a>Function-level caching</h2>
<p>Any function can be cached using: <code><a href="../reference/robustDigest.html">Cache(FUN = functionName, ...)</a></code>.</p>
<p>This will be a slight change to a function call, such as: <code><a href="https://rdrr.io/pkg/raster/man/projectRaster.html">projectRaster(raster, crs = crs(newRaster))</a></code> to <code><a href="../reference/robustDigest.html">Cache(projectRaster, raster, crs = crs(newRaster))</a></code>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">ras &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span>(<span class="dv">0</span>, <span class="fl">1e3</span>, <span class="dv">0</span>, <span class="fl">1e3</span>), <span class="dt">res =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">  map &lt;-<span class="st"> </span><span class="kw"><a href="../reference/robustDigest.html">Cache</a></span>(gaussMap, ras, <span class="dt">cacheRepo =</span> <span class="kw"><a href="../reference/simList-accessors-paths.html">cachePath</a></span>(mySim),</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">               <span class="dt">notOlderThan =</span> <span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>())</a>
<a class="sourceLine" id="cb31-5" data-line-number="5">})</a></code></pre></div>
<pre><code>##    user  system elapsed 
##   2.328   0.087   2.415</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co"># vastly faster the second time</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">  mapCached &lt;-<span class="st"> </span><span class="kw"><a href="../reference/robustDigest.html">Cache</a></span>(gaussMap, ras, <span class="dt">cacheRepo =</span> <span class="kw"><a href="../reference/simList-accessors-paths.html">cachePath</a></span>(mySim))</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">})</a></code></pre></div>
<pre><code>##   ...(Object to retrieve is large: 7.1 Mb)</code></pre>
<pre><code>##   loading cached result from previous gaussMap call, adding to memoised copy</code></pre>
<pre><code>##    user  system elapsed 
##   0.081   0.004   0.084</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(map, mapCached) </a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="working-with-the-cache-manually" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-the-cache-manually" class="anchor"></a>Working with the Cache manually</h2>
<p>Since the cache is simply an <code>archivist</code> repository, all <code>archivist</code> functions will work as is. In addition, there are several helpers in the <code>reproducible</code> package, including <code>showCache</code>, <code>keepCache</code> and <code>clearCache</code> that may be useful. Also, one can access cached items manually (rather than simply rerunning the same <code>Cache</code> function again).</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="co"># examine a part of the Cache</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw"><a href="http://reproducible.predictiveecology.org/reference/viewCache.html">showCache</a></span>(mySim)[tagKey <span class="op">==</span><span class="st"> "function"</span>, <span class="op">-</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"artifact"</span>)]</a></code></pre></div>
<pre><code>## Cache size:</code></pre>
<pre><code>##   Total (including Rasters): 2.3 Mb</code></pre>
<pre><code>##   Selected objects (not including Rasters): 2.3 Mb</code></pre>
<pre><code>##      tagKey tagValue         createdDate
## 1: function gaussMap 2019-11-19 11:03:05
## 2: function   spades 2019-11-19 11:02:58
## 3: function   spades 2019-11-19 11:03:02
## 4: function      FUN 2019-11-19 11:03:02
## 5: function   spades 2019-11-19 11:03:02
## 6: function      FUN 2019-11-19 11:03:02</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span>(<span class="st">"archivist"</span>)) {</a>
<a class="sourceLine" id="cb44-2" data-line-number="2">  <span class="co"># get the RasterLayer that was produced with the gaussMap function:</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3">  map &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="kw"><a href="http://reproducible.predictiveecology.org/reference/viewCache.html">showCache</a></span>(mySim, <span class="dt">userTags =</span> <span class="st">"gaussMap"</span>)<span class="op">$</span>artifact) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="st">    </span>archivist<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/archivist/man/loadFromRepo.html">loadFromLocalRepo</a></span>(<span class="dt">repoDir =</span> <span class="kw"><a href="../reference/simList-accessors-paths.html">cachePath</a></span>(mySim), <span class="dt">value =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb44-5" data-line-number="5">  <span class="kw">clearPlot</span>()</a>
<a class="sourceLine" id="cb44-6" data-line-number="6">  <span class="kw">Plot</span>(map)</a>
<a class="sourceLine" id="cb44-7" data-line-number="7">}</a></code></pre></div>
<pre><code>## Cache size:</code></pre>
<pre><code>##   Total (including Rasters): 2.3 Mb</code></pre>
<pre><code>##   Selected objects (not including Rasters): 1.9 Mb</code></pre>
<p><img src="iii-cache_files/figure-html/manual-cache-1.png" width="700"></p>
</div>
</div>
<div id="reproducible-workflow" class="section level1">
<h1 class="hasAnchor">
<a href="#reproducible-workflow" class="anchor"></a>Reproducible Workflow</h1>
<p>In general, we feel that a liberal use of <code>Cache</code> will make a reusable and reproducible work flow. <code>shiny</code> apps can be made, taking advantage of <code>Cache</code>. Indeed, much of the difficulty in managing data sets and saving them for future use, can be accommodated by caching.</p>
<div id="nested-caching" class="section level2">
<h2 class="hasAnchor">
<a href="#nested-caching" class="anchor"></a>Nested Caching</h2>
<ul>
<li>Imagine we have large model with many modules</li>
<li>To run this would have a nested structure with the following functions:</li>
</ul>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1">simInit <span class="op">-</span>-&gt;<span class="st"> </span>many .inputObjects calls</a>
<a class="sourceLine" id="cb48-2" data-line-number="2"></a>
<a class="sourceLine" id="cb48-3" data-line-number="3">spades call <span class="op">-</span>-&gt;<span class="st"> </span>many module calls <span class="op">-</span>-&gt;<span class="st"> </span>many event calls <span class="op">-</span>-&gt;<span class="st"> </span>many <span class="cf">function</span> calls</a></code></pre></div>
<p>Lets say we start to introduce caching to this structure. We start from the “inner” most functions that we could imaging Caching would be useful. Lets say there are some GIS operations, like <code><a href="https://rdrr.io/pkg/raster/man/projectRaster.html">raster::projectRaster</a></code>, which operates on an input shapefile. We can Cache the <code>projectRaster</code> call to make this much faster, since it will always be the same result for a given input raster.</p>
<p>If we look back at our structure above, we see that we still have LOTS of places that are not Cached. That means that the spades call will still spawn many module calls, and many event calls, just to get to the one <code><a href="../reference/robustDigest.html">Cache(projectRaster)</a></code> call which is Cached. This function will likely be called many times. This is good, but <strong><code>Cache</code> does take some time</strong>. So, even if <code><a href="../reference/robustDigest.html">Cache(projectRaster)</a></code> takes only 0.02 seconds, calling it hundreds of times means maybe 4 seconds. If we are doing this for many functions, then this will be too slow for some purposes.</p>
<p>We can start putting <code>Cache</code> all up the sequence of calls. Unfortunately, the way we use Cache at each of these levels is a bit different, so we need a slightly different approach for each.</p>
<div id="cache-the-spades-call" class="section level4">
<h4 class="hasAnchor">
<a href="#cache-the-spades-call" class="anchor"></a>Cache the <code>spades</code> call</h4>
<p><code><a href="../reference/spades.html">spades(cache = TRUE)</a></code></p>
<p>This will cache the <code>spades</code> call, causing stochasticity/randomness to be frozen.</p>
</div>
<div id="cache-a-whole-module" class="section level4">
<h4 class="hasAnchor">
<a href="#cache-a-whole-module" class="anchor"></a>Cache a whole module</h4>
<p>Pass <code>.useCache = TRUE</code> as a parameter to the module, during the <code>simInit</code></p>
<p>Some modules are inherently non-random, such as GIS modules, or parameter fitting statistical modules. We expect these to be identical results each time, so we can safely cache the entire module.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1">parameters =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb49-2" data-line-number="2">  <span class="dt">FireModule =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">.useCache =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb49-3" data-line-number="3">)</a>
<a class="sourceLine" id="cb49-4" data-line-number="4">mySim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simInit.html">simInit</a></span>(..., <span class="dt">params =</span> parameters)</a>
<a class="sourceLine" id="cb49-5" data-line-number="5">mySimOut &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spades.html">spades</a></span>(mySim)</a></code></pre></div>
<p>The messaging should indicate the caching is happening on every event in that module.</p>
<p><strong><em>Note: This option REQUIRES that the metadata in inputs and outputs be exactly correct, i.e., all <code>inputObjects</code> and <code>outputObjects</code> must be correctly identified and listed in the <code>defineModule</code> metadata</em></strong></p>
<p><strong><em>If the module is cached, and there are errors when it is run, it almost is guaranteed to be a problem with the <code>inputObjects</code> and <code>outputObjects</code> incorrectly specified.</em></strong></p>
</div>
<div id="cache-individual-functions" class="section level4">
<h4 class="hasAnchor">
<a href="#cache-individual-functions" class="anchor"></a>Cache individual functions</h4>
<p><code>Cache(&lt;functionName&gt;, &lt;other arguments&gt;)</code></p>
<p>This will allow fine scale control of individual function calls.</p>
</div>
</div>
<div id="data-to-decisions" class="section level2">
<h2 class="hasAnchor">
<a href="#data-to-decisions" class="anchor"></a>Data-to-decisions</h2>
<p>Once nested Caching is used all the way up to the <code>experiment</code> (see <code>SpaDES.experiment</code> package) level and even further up (e.g., if there is a <code>shiny</code> module), then even very complex models can be put into a complete workflow.</p>
<p>The current vision for <code>SpaDES</code> is that it will allow this type of “data to decisions” complete workflow that allows for deep, robust models, across disciplines, with easily accessible front ends, that are quick and responsive to users, yet can handle data changes, module changes, etc.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#caching-as-part-of-spades">Caching as part of <code>SpaDES</code></a><ul class="nav nav-pills nav-stacked">
<li><a href="#at-the-spades-level">At the <code>spades</code> level</a></li>
      <li><a href="#module-level-caching">Module-level caching</a></li>
      <li><a href="#event-level-caching">Event-level caching</a></li>
      <li><a href="#function-level-caching">Function-level caching</a></li>
      <li><a href="#working-with-the-cache-manually">Working with the Cache manually</a></li>
      </ul>
</li>
      <li>
<a href="#reproducible-workflow">Reproducible Workflow</a><ul class="nav nav-pills nav-stacked">
<li><a href="#nested-caching">Nested Caching</a></li>
      <li><a href="#data-to-decisions">Data-to-decisions</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alex M Chubaty, Eliot J B McIntire.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
